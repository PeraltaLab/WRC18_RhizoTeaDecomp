---
title: Consequences of Long-term Fertilization on Wetland Microbial Community Structure
  and Function
author: "Megan E. Koceja, Regina Bledsoe, Carol Goodwillie, Ariane L. Peralta"
date: "Last updated on `r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    df_print: paged
  fig_caption: yes
  pdf_document: null
header-includes:
- \usepackage{array}
- \usepackage{graphics}
- \usepackage[utf8]{inputenc}
---

Project Description: Fill out

# Initial Setup
```{r Initial Setup, include=FALSE}
rm(list=ls())
setwd("~/GitHub/WRC18_RhizoTeaDecomp/analyses")
se <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}
ci <- function(x, ...){1.96 * sd(x,na.rm = TRUE)}

# Code Dependencies
source("../bin/DiversityFunctions.R")
source("../bin/MothurTools.R")
require("vegan")
require("nlme")
require("reshape")
require("ggplot2")
require("ade4")
require("png")
require ("agricolae")
require("tidyr")
require("dplyr")
require("reshape2")
require("picante")
```
#Import Files
## Environmental Data
```{r Import Files - Env, include=FALSE}
# Import Environmental Data
design <- read.csv("../data/2018_WRC_SoilMicroDecomp_missing3t.csv", row.names=1)
```
## Bacterial Data - including tea only
```{r Import Files - Bacteria, include=FALSE}
# Import OTU data
# Import Raw Data
otu.in <- read.otu("../data/WRC18_opti_mcc.shared")

# Correct Sample IDs and Subset File
missing <- setdiff(rownames(otu.in), rownames(design))
otu <- otu.in[-(which(rownames(otu.in) %in% missing)), ]
dim(otu)
otu <- otu[match(rownames(design), rownames(otu)),]
all.equal(rownames(otu), rownames(design))

# OTU table - remove otus w/ < 2 occurrences across all sites
otu_removal <- otu[, which(colSums(otu) >= 2)]
dim(otu_removal)

aa <- (rowSums(otu_removal))
aa # WRC18_10_Tea-155 reads WRC18_13_Tea-29 reads - removed

# OTU table - removed low abundance samples
otu_low_remov <- otu_removal[which(rowSums(otu_removal) >= 1000), ]
dim(otu_low_remov)

# OTU table - odd sites in bacterial composition data and remove in design file
odd.sites <- c("WRC18_10_Tea","WRC18_13_Tea")

otu_final <- otu_low_remov[setdiff(rownames(otu_low_remov), odd.sites), ]
design_final <- design[setdiff(rownames(design), odd.sites), ]
all.equal(rownames(design_final), rownames(otu_final))

otus <- otu_final

###subset tea only

otus.design <- cbind(design_final,otus)
otus.design.teas <- subset(otus.design, source == "green_tea" | source == "rooibos_tea")
dim(otus.design.teas)                   

design.t <- otus.design.teas[,c(1:16)]
otus.t <- otus.design.teas[,-c(1:16)]
#full df - otus.design.teas

# Make Relative Abundance Matrices
dataREL.t <- otus.t
for(i in 1:dim(otus.t)[1]){
  dataREL.t[i,] <- otus.t[i,]/sum(otus.t[i,])
}
```
# Simple Hypothesis Testing - Microbial Community (tea only)
```{r perMANOVA - Bacteria - All Yrs, echo=TRUE}
#PERMANOVA
new.data.t <-cbind(design.t,dataREL.t)
adonis = adonis(new.data.t[,-c(1:16)]~source*treatment*ditch, method = "bray", data = new.data.t, perm=1000)
adonis
```
# Bacterial Ordinations

## Principal Coordinates Ordination
```{r Ordination (PCoA) - Bacteria - tea only, include=FALSE}
# Principal Coordinates Analysis
dataREL.dist <- vegdist(dataREL.t, method="bray")

pcoa <- cmdscale(dataREL.dist, k=3, eig=TRUE, add=FALSE)
  # Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
  # eig=TRUE returns eigenvalues; k = # of dimensions to calculate

explainvar1b <- round(pcoa$eig[1] / sum(pcoa$eig), 3) * 100
explainvar2b <- round(pcoa$eig[2] / sum(pcoa$eig), 3) * 100
sum.eigb <- sum(explainvar1b, explainvar2b)

explainvar1b #22.2
explainvar2b #10.1
```

```{r Ordination (PCoA) - Bacteria, include=FALSE}
# Principal Coordinates Analysis - teas only #NEED to incorporate ditch
new.data.t <-cbind(design.t,dataREL.t)
droplevels(new.data.t$source)
pcoa.groups <- paste(new.data.t$treatment, new.data.t$source, new.data.t$ditch, sep = "_")
pcoa.points <- data.frame(pcoa$points, group = pcoa.groups)

# Calculate Centroids (mean and SE)
pcoa.L.centroids <- melt(pcoa.points, id="group", measure.vars = c("X1", "X2"))
pcoa.centroids <- acast(pcoa.L.centroids, variable ~ group, mean)
pcoa.centroids.se <- acast(pcoa.L.centroids, variable ~ group, se)
pcoa.centroids.sd <- acast(pcoa.L.centroids, variable ~ group, sd)

# Combine
pcoa.cent.dataframe <- cbind(t(pcoa.centroids), t(pcoa.centroids.se))
colnames(pcoa.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")
pcoa.cent.treats <- rownames(pcoa.cent.dataframe)
trt.t <- c("M","M","M","M","MF","MF","MF","MF")
source.ditch.t <- c("green_tea (wet_0ditch)","green_tea (dry_1ditch)","rooibos_tea (wet_0ditch)","rooibos_tea (dry_1ditch)","green_tea (wet_0ditch)","green_tea (dry_1ditch)","rooibos_tea (wet_0ditch)","rooibos_tea (dry_1ditch)")
pcoa.cent.dataframe.trts <- as.data.frame(pcoa.cent.dataframe)
pcoa.cent.dataframe.trts$trt <- as.factor(trt.t)
pcoa.cent.dataframe.trts$source <- as.factor(source.ditch.t)

#pcoa.col <- as.factor(sapply(strsplit(pcoa.cent.treats, "_"), `[`, 2)) # group
#pcoa.shape <- as.factor(sapply(strsplit(pcoa.cent.treats, "_"), `[`, 1)) # group

#Plot
df1a <- as.data.frame(pcoa.cent.dataframe.trts)
plot1a <- ggplot(df1a, aes(x=V1, y=V2, colour=trt, shape = source,
                           group = interaction(trt, source))) + theme_bw() 
plot1a + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
theme(panel.background = element_blank()) + 
geom_point(aes(colour=trt.t), size=5, stroke = 1.25, show.legend = TRUE) +
geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e, height=0.01), colour="black") + geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e, width=0.01), colour="black") +
scale_colour_manual(labels = c("mowed","mowed/fertilized"), 
                    values = c("darkgray", "darkgreen")) + 
scale_shape_manual(labels = c("green_tea (wet_0ditch)", 
                              "green_tea (dry_1ditch)", 
                              "rooibos_tea (wet_0ditch)",
                              "rooibos_tea (dry_1ditch"), 
                   values = c(16,21,17,24)) +
theme(axis.title = element_text(size=14), axis.text = element_text(size=14),
      axis.text.x = element_text(size=14), 
      panel.border = element_rect(colour = "black", size = 1.25)) + 
theme(axis.ticks.length = unit(0.3, "cm")) + 
xlab("PCoA 1 (22.2%)") + ylab("PCoA 2 (10.1%)") +
  labs(colour = "treatment", shape = "source + ditch") +
  guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
         shape = guide_legend(override.aes = list(size = 4)))
ggsave("../figures/Ordination_tea.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=9, height=7, dpi=300, limitsize=TRUE)
```

#Loading data file
```{r Loading Files, include=FALSE}
# load data file for TBI
TBI <- read.csv("../data/2018_WRC_TBI_Rstats.csv", row.names=1) #removed sampleID#17
dim(TBI)
```

# relationship between S and k
```{r Loading Files, include=FALSE}
#need to incorporate ditch
TBI$trt <- as.factor(TBI$Treatment)
TBI$ditch <- as.factor(TBI$Ditch)

p <- ggplot(TBI, aes(x=S, y=k, color=trt, shape=ditch))+ scale_color_manual(name="Treatment", values=c("darkgray","darkgreen"), labels = c("Mowed", "Mowed/Fertilized")) + geom_point(size=5) + scale_shape_manual(name="Ditch", values = c(16,21), labels = c("wet_0ditch","dry_1ditch"))
p1=p+geom_point()
TBI <- p1 + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black")) +theme(axis.title=element_text(vjust=1,size=18), axis.text=element_text(size=18), axis.text.x = element_text(vjust=0.65, hjust=0.5, size=18), panel.border = element_rect(colour = "black",size=1)) + theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Stabilization factor (S)", y = "Decomposition rate (k)") + theme(strip.text.x = element_text(size=18, face="bold"), strip.text.y = element_text(size=18, face="bold"), strip.background = element_rect(colour="black", fill="white", size=1))
TBI
ggsave("../figures/TBI.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```

# Tea Decomp Biomass
```{r Loading Files, include=FALSE}
#subset tea only rows
tea <- subset(design, source != "bulk_soil")

aov.fit1 <- aov(Percent_Loss~treatment*source, tea)
summary(aov.fit1)

posthoc <- TukeyHSD(x=aov.fit1, conf.level=0.95)
posthoc

aov.fit2 <- aov(Percent_Loss~treatment*source*ditch, tea)
summary(aov.fit2)

#posthoc2 <- TukeyHSD(x=aov.fit2, conf.level=0.95)
#posthoc2

# Graphing Percent Loss 
ditch.labs <- c("wet_0ditch","dry_1ditch") #for facet labels
names(ditch.labs) <- c("0", "1")

p <- ggplot(tea, aes(x=source, y=Percent_Loss, color=as.factor(treatment)))+ scale_color_manual(name="Treatment", values=c("darkgray", "darkgreen"), labels = c("mowed", "mowed/fertilized")) + stat_summary(fun.data=mean_cl_boot,size=0.75) 
p1=p+geom_smooth(method="lm")+facet_wrap(~ditch)+facet_grid(. ~ ditch,labeller = labeller(ditch=ditch.labs))
p1 + theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line 
          =element_line(colour = "black")) + 
    theme(axis.title=element_text(vjust=1,size=14,face="bold"),
          axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, 
          size=14), panel.border = element_rect(colour = "black",size=1)) + 
    theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Source", y = "Percent Loss") + 
    theme(strip.text.x = element_text(size=14, face="bold"), strip.text.y =   
          element_text(size=14, face="bold"), strip.background = element_rect(colour="black",
          fill="white", size=1)) +
    scale_x_discrete(breaks=c("green_tea", "rooibos_tea"), labels=c("green tea", "rooibos tea"))
ggsave("../figures/PercentLoss.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```

## Bacterial Data - including bulk and tea
```{r Import Files - Bacteria, include=FALSE}
# Important Environmental data
design <- read.csv("../data/2018_WRC_SoilMicroDecomp_missing3t.csv", row.names=1)

# Import OTU data
# Import Raw Data
otu.in <- read.otu("../data/WRC18_opti_mcc.shared")

# Correct Sample IDs and Subset File
missing <- setdiff(rownames(otu.in), rownames(design))
otu <- otu.in[-(which(rownames(otu.in) %in% missing)), ]
dim(otu)
otu <- otu[match(rownames(design), rownames(otu)),]
all.equal(rownames(otu), rownames(design))

# OTU table - remove otus w/ < 2 occurrences across all sites
otu_removal <- otu[, which(colSums(otu) >= 2)]
dim(otu_removal)

aa <- (rowSums(otu_removal))
aa # WRC18_10_Tea-155 reads WRC18_13_Tea-29 reads - removed

# OTU table - removed low abundance samples
otu_low_remov <- otu_removal[which(rowSums(otu_removal) >= 1000), ]
dim(otu_low_remov)

# OTU table - odd sites in bacterial composition data and remove in design file
odd.sites <- c("WRC18_10_Tea","WRC18_13_Tea")

otu_final <- otu_low_remov[setdiff(rownames(otu_low_remov), odd.sites), ]
design_final <- design[setdiff(rownames(design), odd.sites), ]
all.equal(rownames(design_final), rownames(otu_final))

otus <- otu_final

# Make Presence Absence Matrix
dataPA <- (otus > 0) * 1

# Make Relative Abundance Matrices
dataREL <- otus
for(i in 1:dim(otus)[1]){
  dataREL[i,] <- otus[i,]/sum(otus[i,])
}

# Import Taxonomy File
otu.tax <- read.tax(taxonomy = "../data/WRC18_opti_mcc.0.03.cons.taxonomy",
                   format = "rdp", tax.levels = 6, col.tax = 3)
```
# Diversity Metrics - Hypothesis Testing
```{r Diversity Metrics - Bacteria, echo=TRUE}
# Rarefy Abundances (min abundance is 29485. We are sampling to 29000)
min(rowSums(otus))
otus.r <- rrarefy(otus, 29000)

# Fisher's Alpha
fisher <- fisher.alpha(otus.r)

# Species Richness
#richness <- rowSums((PWESdata.r >= 1))
richness <- rowSums((otus >= 1))

# Shannon Diversity
shannon <- diversity(otus.r, "shannon")

# Simpson's Evenness
simp.even <- apply(otus.r, 1, simp_even)

#Pielouâ€™s evenness
J <- shannon/log(specnumber(otus.r[,-c(1:1)]))

#combined richness, diversity, evenness
diversity <- cbind(design_final,richness,shannon,simp.even,J)
write.csv(diversity,"../data/diversity.bact.raw.csv")
```

# Diversity Metrics - Hypothesis Testing
```{r Hypothesis Testing - Bacteria, echo=TRUE}
#summary table for bacterial diversity
summary <- diversity %>% group_by(source, treatment, ditch) %>% summarise(mean.richness=mean(richness), se.richness=se(richness), mean.shannon=mean(shannon), se.shannon=se(shannon),mean.evenness=mean(simp.even), se.evenness=se(simp.even))
print(summary)
write.csv(summary,"../data/diversity.bact.summary.csv")

#summary table for soils
summary <- diversity %>% group_by(source, treatment, ditch) %>% summarise(mean.soilC=mean(c_percent), se.soilC=se(c_percent), mean.soilN=mean(n_percent), se.soilN=se(n_percent),mean.soilCN=mean(C_N), se.soilCN=se(C_N),mean.ammonium=mean(n_nh4_ug_gsoil), se.ammonium=se(n_nh4_ug_gsoil),mean.nitrate=mean(n_no3_ug_gsoil), se.nitrate=se(n_no3_ug_gsoil),mean.phosphate=mean(p_po4_w_ug_gsoil), se.phosphate=se(p_po4_w_ug_gsoil))
print(summary)
write.csv(summary,"../data/diversity.soil.summary.csv")

library(lmerTest)

richness.lm <- lmer(richness ~ source*treatment*ditch + (1|block), data = diversity)
plot(richness.lm)
richness.lm
anova(richness.lm)

evenness.lm <- lmer(simp.even ~ source*treatment*ditch + (1|block), data = diversity)
plot(evenness.lm)
evenness.lm
anova(evenness.lm)

shannon.lm <- lmer(shannon ~ source*treatment*ditch + (1|block), data = diversity)
plot(shannon.lm)
shannon.lm
anova(shannon.lm)
```

#Plot shannon diversity 
```{r Plot - Shannon Diversity, echo=TRUE}
ditch.labs <- c("wet_0ditch", "dry_1ditch") #for facet labels
names(ditch.labs) <- c("0", "1")
# Graphing Shannon Diversity
p <- ggplot(diversity, aes(x=source, y=shannon, color=as.factor(treatment)))+ scale_color_manual(name="Treatment", values=c("gray", "darkgreen"), labels = c("mowed", "mowed/fertilized")) + stat_summary(fun.data=mean_cl_boot,size=0.75) 
p1=p+geom_smooth(method="lm")+facet_wrap(~ditch)+facet_grid(. ~ ditch,labeller = labeller(ditch=ditch.labs))
p1 + theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line 
          =element_line(colour = "black")) + 
    theme(axis.title=element_text(vjust=1,size=14,face="bold"),
          axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, 
          size=14), panel.border = element_rect(colour = "black",size=1)) + 
    theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Source", y = "Shannon Diversity Index (H')") + 
    theme(strip.text.x = element_text(size=14, face="bold"), strip.text.y =   
          element_text(size=14, face="bold"), strip.background = element_rect(colour="black",
          fill="white", size=1)) +
    scale_x_discrete(breaks=c("bulk_soil", "green_tea", "rooibos_tea"), labels=c("soil", "green", 
          "rooibos"))
  
ggsave("../figures/shannon.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```
#Plot richness 
```{r Plot - OTU richness, echo=TRUE}
# Graphing Richness
p <- ggplot(diversity, aes(x=source, y=richness, color=as.factor(treatment)))+ scale_color_manual(name="Treatment", values=c("gray", "darkgreen"), labels = c("mowed", "mowed/fertilized")) + stat_summary(fun.data=mean_cl_boot,size=0.75)
p1=p+geom_smooth(method="lm")+facet_wrap(~ditch)+facet_grid(. ~ ditch,labeller = labeller(ditch=ditch.labs))
p1 + theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line 
          =element_line(colour = "black")) + 
    theme(axis.title=element_text(vjust=1,size=14,face="bold"),
          axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, 
          size=14), panel.border = element_rect(colour = "black",size=1)) + 
    theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Source", y = "OTU richness") + 
    theme(strip.text.x = element_text(size=14, face="bold"), strip.text.y =   
          element_text(size=14, face="bold"), strip.background = element_rect(colour="black",
          fill="white", size=1)) +
    scale_x_discrete(breaks=c("bulk_soil", "green_tea", "rooibos_tea"), labels=c("soil", "green", 
          "rooibos"))
  
ggsave("../figures/richness.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```

#Plot Simpson's Evenness
```{r Plot Simpson's Evenness, echo=TRUE}
# Graphing Simpson's Evenness
p <- ggplot(diversity, aes(x=source, y=simp.even, color=as.factor(treatment)))+ scale_color_manual(name="Treatment", values=c("gray", "darkgreen"), labels = c("mowed", "mowed/fertilized")) + stat_summary(fun.data=mean_cl_boot,size=0.75) 
p1=p+geom_smooth(method="lm")+facet_wrap(~ditch)+facet_grid(. ~ ditch,labeller = labeller(ditch=ditch.labs))
p1 + theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line 
          =element_line(colour = "black")) + 
    theme(axis.title=element_text(vjust=1,size=14,face="bold"),
          axis.text=element_text(size=14), axis.text.x = element_text(vjust=0.65, hjust=0.5, 
          size=14), panel.border = element_rect(colour = "black",size=1)) + 
    theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Source", y = "Simpson's Evenness") + 
    theme(strip.text.x = element_text(size=14, face="bold"), strip.text.y =   
          element_text(size=14, face="bold"), strip.background = element_rect(colour="black",
          fill="white", size=1)) +
    scale_x_discrete(breaks=c("bulk_soil", "green_tea", "rooibos_tea"), labels=c("soil", "green", 
          "rooibos"))
  
ggsave("../figures/evenness.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=7, height=5, dpi=300, limitsize=TRUE)
```
# Simple Hypothesis Testing - Microbes
```{r perMANOVA - Bacteria - All sources, echo=TRUE}
#PERMANOVA
new.data <-cbind(design_final,dataREL)
adonis = adonis(new.data[,-c(1:16)]~source*treatment*ditch, method = "bray", data = new.data, perm=1000)
adonis
```
# Bacterial Ordinations
```{r Ordination (PCoA) - Bacteria - bulk and teas, include=FALSE}
# Principal Coordinates Analysis
dataREL.dist <- vegdist(dataREL, method="bray")

pcoa <- cmdscale(dataREL.dist, k=3, eig=TRUE, add=FALSE)
  # Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
  # eig=TRUE returns eigenvalues; k = # of dimensions to calculate

explainvar1b <- round(pcoa$eig[1] / sum(pcoa$eig), 3) * 100
explainvar2b <- round(pcoa$eig[2] / sum(pcoa$eig), 3) * 100
sum.eigb <- sum(explainvar1b, explainvar2b)

explainvar1b #43.3
explainvar2b #10.6
```

```{r Ordination (PCoA) - Bacteria, include=FALSE}
# Principal Coordinates Analysis - bulk and teas
#new.data <-cbind(design_final,dataREL)
pcoa.groups <- paste(new.data$treatment, new.data$source, new.data$ditch, sep = "_")
pcoa.points <- data.frame(pcoa$points, group = pcoa.groups)

# Calculate Centroids (mean and SE)
pcoa.L.centroids <- melt(pcoa.points, id="group", measure.vars = c("X1", "X2"))
pcoa.centroids <- acast(pcoa.L.centroids, variable ~ group, mean)
pcoa.centroids.se <- acast(pcoa.L.centroids, variable ~ group, se)
pcoa.centroids.sd <- acast(pcoa.L.centroids, variable ~ group, sd)

# Combine
pcoa.cent.dataframe <- cbind(t(pcoa.centroids), t(pcoa.centroids.se))
colnames(pcoa.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")
pcoa.cent.treats <- rownames(pcoa.cent.dataframe)
trt.t.s <- c("M","M","M","M","M","M","MF","MF","MF","MF","MF","MF")
source.ditch.t.s <- c("bulk_soil (wet_0ditch)","bulk_soil (dry_1ditch)","green_tea (wet_0ditch)","green_tea (dry_1ditch)","rooibos_tea (wet_0ditch)","rooibos_tea (dry_1ditch)","bulk_soil (wet_0ditch)","bulk_soil (dry_1ditch)","green_tea (wet_0ditch)","green_tea (dry_1ditch)","rooibos_tea (wet_0ditch)","rooibos_tea (dry_1ditch)")
pcoa.cent.dataframe.trts <- as.data.frame(pcoa.cent.dataframe)
pcoa.cent.dataframe.trts$trt <- as.factor(trt.t.s)
pcoa.cent.dataframe.trts$source <- as.factor(source.ditch.t.s)

#Plot
df2a <- as.data.frame(pcoa.cent.dataframe.trts)
plot2a <- ggplot(df2a, aes(x=V1, y=V2, colour=trt, shape = source,
                           group = interaction(trt, source))) + theme_bw() 
plot2a + theme(panel.grid.major = element_blank(), 
               panel.grid.minor = element_blank(), 
               axis.line = element_line(colour = "black")) + 
theme(panel.background = element_blank()) + 
geom_point(aes(colour=trt.t.s), size=5, stroke = 1.25, show.legend = TRUE) +
geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e, height=0.01), colour="black") + geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e, width=0.01), colour="black") +
scale_colour_manual(labels = c("mowed","mowed/fertilized"), 
                    values = c("darkgray", "darkgreen")) + 
scale_shape_manual(labels = c("bulk_soil (wet_0ditch)", 
                              "bulk_soil (dry_1ditch)",
                              "green_tea (wet_0ditch)", 
                              "green_tea (dry_1ditch)", 
                              "rooibos_tea (wet_0ditch)",
                              "rooibos_tea (dry_1ditch"), 
                   values = c(15,22,16,21,17,24)) +
theme(axis.title = element_text(size=14), axis.text = element_text(size=14),
      axis.text.x = element_text(size=14), 
      panel.border = element_rect(colour = "black", size = 1.25)) + 
theme(axis.ticks.length = unit(0.3, "cm")) + 
xlab("PCoA 1 (43.3%)") + ylab("PCoA 2 (10.6%)") +
  labs(colour = "treatment", shape = "source + ditch") +
  guides(colour = guide_legend(override.aes = list(pch=16, size = 4)),
         shape = guide_legend(override.aes = list(size = 4)))
ggsave("../figures/Ordination_bulk_tea.pdf", plot=last_plot(), device=NULL, path=NULL, scale=1, width=9, height=7, dpi=300, limitsize=TRUE)
```

# Bacterial community indicator species
```{r Bacteria Indicator Species, include=FALSE}
#new.data <-cbind(design_final,dataREL) - includes bulk and tea sources
library("labdsv")
group = interaction(new.data$source, new.data$treatment, new.data$ditch)
design.type <- group #treatment x fertilization x ditch
dataREL.t <- new.data[,-c(1:16)]

dataREL <- dataREL.t[, colSums(dataREL.t) > 0.05]
bac.ind <- indval(dataREL, design.type)
levels(design.type)
summary(bac.ind)

inds <- which(bac.ind$pval <= 0.05)
bac.indicators <- as.data.frame(matrix(NA, nrow = length(inds), ncol = 4))
colnames(bac.indicators) <- c("OTU", "Cluster", "IndVal", "Prob")

bac.indicators$OTU <- names(inds)
bac.indicators$Cluster <- bac.ind$maxcls[inds]
bac.indicators$IndVal <- bac.ind$indcls[inds]
bac.indicators$Prob <- bac.ind$pval[inds]

ind.tax <- otu.tax[which(as.character(otu.tax$OTU) %in% bac.indicators$OTU), ]
ind.tax <- ind.tax[match(ind.tax$OTU, bac.indicators$OTU), ]

indicator.bac <- cbind(bac.indicators, ind.tax[, -c(1)])

indicator.bac <- indicator.bac[order(as.numeric(indicator.bac$Cluster)), ]

table(indicator.bac$Cluster)
table(indicator.bac$Phylum)
table(indicator.bac$Cluster)
levels(design.type)

# Export Bacteria Indicator Table
write.table(indicator.bac, "../data/BacterialIndicators_source.txt",
            sep="\t", row.names = F, quote = F)
```