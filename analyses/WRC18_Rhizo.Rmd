---
title: "WRC2018_Rhizo"
author: "Regina A. B. Bledsoe, Ariane L. Peralta"
date: "May 8, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning=FALSE)
#use to set working directory 
knitr::opts_knit$set(root.dir="../GitHub/WRC18_RhizoTeaDecomp/analyses")

```

```{r load packages, include=FALSE}
getwd()

#Set source R tools
source("../bin/DiversityFunctions.R")
source("../bin/MothurTools.R")

#load req'd packages 
require("vegan")
require("dplyr")
require("tidyverse")
require("ecodist")
require("ggplot2")
require("phyloseq")
require("agricolae")

#Set Std Err and Conf Int
se <- function(x, ...) {
  sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))
}
ci <- function(x, ...) {
  1.96 * sd(x, na.rm = TRUE)
}

set.seed(42)
```

```{r load data, include=FALSE}
getwd()
#Load data files 
#Assign file names to variables
sharedfile = "../data/WRC18_Rhizo/WRC15_18Rhizo.opti_mcc.shared"
taxfile = "../data/WRC18_Rhizo/WRC15_18Rhizo.opti_mcc.0.03.cons.taxonomy"
metafile = "../data/WRC18_Rhizo/2015_2018_WestResearchCampus_Sampling_Summary.csv"

#Read in design file
meta <- read.csv(metafile)
#head(meta)

#Read in OTU file
otu <- read.otu(sharedfile)

#Read in taxonomy file
#tax <- read.tax(taxfile)
#read.tax does not work and I was unable to solve issue. I use phyloseq import_mothur as a work around. 
tax <- import_mothur(mothur_constaxonomy_file =  taxfile)
tax.df <- as.data.frame(tax)
colnames(tax.df)=c("Domain","Phylum","Class", "Order","Family","Genus")
tax <- tax_table(tax.df)
```
```{r filter meta and otu datasets and rarefy}
#Remove OTUs with less than 2 occurences across all sites
otu.2 <- otu[, which(colSums(otu) >2)]
#If needed can try to reduce tax dataset by removing otus removed from otu file
#otu.1 <- otu[, which(colSums(otu) <2)]
#list <- colnames(otu.1)
#This bit not working atm
#tax.trim <- tax[-c(list),]

#Remove all RP samples
#In the original WRC2015 sampling I collected bulk soils, and rhizospehre soils. Soil loosley adhering to roots was shaken into a bag (RP) for DNA and soil NH4/NO3 extraction. Roots and adhering soils collected for DNA processing (RS). Removed RP from DNA analysis.
#WRC15_65-WRC15_80
rownames(otu.2)
otu.2 <-otu.2[-c(33:48),]
#rownames(otu.2)

#FROM OTU - remove blocks 1, 3, 5, 7 and treatments C & F
#First join meta and otu. Filter and then remove extra columns
otu.2.filter <- as.data.frame(cbind(block = meta$block, treatment = meta$treatment, sample = meta$sample, year = meta$year, otu.2))
otu.2.filter <- otu.2.filter[which(otu.2.filter$block!=1 & otu.2.filter$block!=3 & otu.2.filter$block!=5 & otu.2.filter$block!=7 & meta$treatment!="C" & meta$treatment!="F" & meta$year!=2015),]
otu.2 <- otu.2.filter[,-c(1:4)]
rownames(otu.2.filter)

#FROM META - remove blocks 1, 3, 5, 7 and treatments C & F
meta <- meta[which(meta$block!=1 & meta$block!=3 & meta$block!=5 & meta$block!=7 & meta$treatment!="C" & meta$treatment!="F" & meta$year!=2015),]

#What sample has lowest read count? WRC18_201 16668, next lowest is WRC18_200 43192 highest WRC15_167 68819
otu2<- colSums(t(otu.2))
otu2
otu2[which.min(colSums(t(otu.2)))]
otu2[which.max(colSums(t(otu.2)))]
#Did not remove lowest sample
#rownames(otu.2)
#otu.2 <- otu.2[-c(17),]

#graph of read counts, need to work on y axis
c<-as.data.frame(otu.2)
c$colsum <- colSums(t(c))
c$group <- rownames(c)
p<-ggplot(c, aes(x=group,y=colsum))+geom_bar(stat="identity")+coord_flip()
p

#Rarefy
#Set min sample number
min.N <- min(rowSums(otu.2))
#rrarefy returns a randomly rarefied community data frame or vector of selected size
#This is the otu set that should be used for beta diversity metrics
otu.rare <- rrarefy(otu.2, min.N)
```

```{r rarefaction curve}
#rarefy returns a species richness estimate in a random subsample of selected size
otu.rare.rich <- rarefy(x = otu.2, sample=min.N, se=T)
#Plot rarefaction curve
###I am not sure how to interpret this. I think it suggests that I did not capture all of the diversity? 
rarecurve(x = otu.2, step = 20, col="blue", cex=0.6, las=1)
abline(0,1,col='red')
text(1000,1000,"1:1",pos=2, col='red')
```
```{r Relative abundance and PERMANOVA }
#transforms read counts to relative abundance
#Using rarefied OTU dataset
otu.2.rel <- otu.rare
for(i in 1:dim(otu.rare)[1]){
  otu.2.rel[i,] <- otu.rare[i,]/sum(otu.rare[i,])
}

#Combine experimental deisng meta data with OTU relative abundance data
metaotu <- cbind(meta, otu.2.rel)
#Where does otu data begin, remove for PERMANOVA
#metaotu[1,20:21]

#PERMANOVA with source and treatment as factors
#Among all treatments source (soil source) and treatment
metaotu.ad <- adonis(metaotu[,-c(1:19)] ~source*treatment, method = "bray", data = metaotu, perm=1000, set.seed=42)
#metaotu.ad <- adonis(metaotu[,-c(1:19)] ~source*treatment*year, method = "bray", data = metaotu, perm=1000, set.seed=42)
metaotu.ad 

#source (soil source) is significant but the PCoA suggests that it is only significant between source and rhizosphere and not source functionl type (grass, forb). Because I can't run a global pairwise analysis I will run individual pairwise analysis between source(soil sources) within a treatment. 
#source (soil source) within treatment

#Pairwise adonis/PERMANOVA of soil source within a treatment
#MOWED UNFERTILIZED
metaotu.M <- metaotu[which(metaotu$treatment=='M'),]
metaotu.M.GF <- metaotu.M[which(metaotu.M$source!='bulk'),]
metaotu.M.BG <- metaotu.M[which(metaotu.M$source!='ec'),]
metaotu.M.BF <- metaotu.M[which(metaotu.M$source!='av'),]

metaotu.M.GF.ad <- adonis(metaotu.M.GF[,-c(1:19)] ~ source, method = "bray", data = metaotu.M.GF, perm=1000, set.seed=42)
metaotu.M.GF.ad 

metaotu.M.BG.ad <- adonis(metaotu.M.BG[,-c(1:19)] ~ source, method = "bray", data = metaotu.M.BG, perm=1000, set.seed=42)
metaotu.M.BG.ad 

metaotu.M.BF.ad <- adonis(metaotu.M.BF[,-c(1:19)] ~ source, method = "bray", data = metaotu.M.BF, perm=1000, set.seed=42)
metaotu.M.BF.ad 

#MOWED FERTILIZED
metaotu.MF <- metaotu[which(metaotu$treatment=='MF'),]
metaotu.MF.GF <- metaotu.MF[which(metaotu.MF$source!='bulk'),]
metaotu.MF.BG <- metaotu.MF[which(metaotu.MF$source!='ec'),]
metaotu.MF.BF <- metaotu.MF[which(metaotu.MF$source!='av'),]

metaotu.MF.GF.ad <- adonis(metaotu.MF.GF[,-c(1:19)] ~ source, method = "bray", data = metaotu.MF.GF, perm=1000, set.seed=42)
metaotu.MF.GF.ad 

metaotu.MF.BG.ad <- adonis(metaotu.MF.BG[,-c(1:19)] ~ source, method = "bray", data = metaotu.MF.BG, perm=1000, set.seed=42)
metaotu.MF.BG.ad 

metaotu.MF.BF.ad <- adonis(metaotu.MF.BF[,-c(1:19)] ~ source, method = "bray", data = metaotu.MF.BF, perm=1000, set.seed=42)
metaotu.MF.BF.ad 

```
```{r Calculate distance matrix and PCoA components }

otu.2.rel.dist<-vegdist(otu.2.rel, method="bray")

# Principal Coordinates Analysis
otu.2.rel.dist.pcoa <- cmdscale(otu.2.rel.dist, k=3, eig=TRUE, add=FALSE)
# Classical (Metric) Multidimensional Scaling; returns PCoA coordinates
# eig=TRUE returns eigenvalues; k = # of dimensions to calculate

explainvar1a <- round(otu.2.rel.dist.pcoa$eig[1] / sum(otu.2.rel.dist.pcoa$eig), 3) * 100
explainvar2a <- round(otu.2.rel.dist.pcoa$eig[2] / sum(otu.2.rel.dist.pcoa$eig), 3) * 100
sum.eiga <- sum(explainvar1a, explainvar2a)

explainvar1a
explainvar2a

```

```{r PCoA Plot }
all.equal(rownames(meta), rownames(otu.2.rel))
# Set treatments
treat1 <- as.factor(meta$source)
levels(treat1) <- ordered(c("bulk","grass", "forb"))
treat2 <- as.factor(meta$treatment)
#treat3 <-as.factor(meta$year)
#levels(treat2) <- c("M", "MF")

#pcoa.groups <- paste(meta$source, meta$treatment, meta$year, sep = "_")
pcoa.groups <- paste(meta$source, meta$treatment, sep = "_")


pcoa.points <- data.frame(otu.2.rel.dist.pcoa$points, group = pcoa.groups)

# Calculate Centroids (mean and SE)
pcoa.L.centroids <- melt(pcoa.points, id="group", measure.vars = c("X1", "X2"))
pcoa.centroids <- acast(pcoa.L.centroids, variable ~ group, mean)
pcoa.centroids.se <- acast(pcoa.L.centroids, variable ~ group, se)
pcoa.centroids.sd <- acast(pcoa.L.centroids, variable ~ group, sd)

# Combine
pcoa.cent.dataframe <- cbind(t(pcoa.centroids), t(pcoa.centroids.se))
colnames(pcoa.cent.dataframe) <- c("V1", "V2", "V1e", "V2e")
pcoa.cent.treats <- rownames(pcoa.cent.dataframe)

pcoa.col <- as.factor(sapply(strsplit(pcoa.cent.treats, "_"), `[`, 2)) # treatment
pcoa.shape <- as.factor(sapply(strsplit(pcoa.cent.treats, "_"), `[`, 1))  # source
#pcoa.col2 <- as.factor(sapply(strsplit(pcoa.cent.treats, "_"), `[`, 3))

#pcoa.shape <- ordered(c("A. virginicus", "Bulk Soil", "E. caroliniana"))
#pcoa.shape <- ordered(pcoa.shape,levels=c("bulk","av", "ec"))
#pcoa.shape <- revalue(pcoa.shape, c("bulk"="Bulk Soil", "av"="Grass", "ec"="Forb"))
#pcoa.shape <- mapvalues(pcoa.shape, from = c("bulk","av","ec"), to = c("Bulk Soil", "Grass", "Forb"))

levels(pcoa.col) <- c("Unfertilized","Fertilized")

#Removed RS samples becuase only have soil porperty values for RP samples
#Run envfit to see which soil varibales are predicators 
colnames(meta)

###Are these just the environmental parameters have values for bulk and rhizospehre soils?
fit<-envfit(otu.2.rel.dist.pcoa$points, meta[,-c(1:12)], perm=1000, na.rm=T, set.seed=42)
fit

A <-as.list(fit$vectors)
vec<-as.data.frame(fit$vectors$arrows*sqrt(fit$vectors$r)*0.35)
p<- as.data.frame(A$pvals)
vec <- cbind(vec, p) 
vec <-  subset(vec, A$pvals<=0.05)

vec$parm<-rownames(vec)
colnames(vec)
#vec$parm<-c("Moisture","pH","C%","N%")

#plot PCoA
df1a <- as.data.frame(pcoa.cent.dataframe)
plot1 <- ggplot(df1a, aes(x=V1, y=V2,  color=pcoa.col, shape = pcoa.shape, 
                 group = interaction(pcoa.col, pcoa.shape))) + theme_bw() +
#group = interaction(pcoa.col, pcoa.shape), colour=pcoa.col2))
  geom_point(aes(shape = pcoa.shape, colour = pcoa.col), size=7) + 
  #geom_point(aes(colour=pcoa.col2), size =4.0)+
  #removes gridlines from plot
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  #Plot soil property vectors from envfit
  geom_segment(data=vec, aes(x=0,xend=Dim1,y=0,yend=Dim2), size=1, 
     arrow = arrow(length = unit(0.2, "cm")),colour="black",inherit.aes=F)+ 
  #Label soil vectors. Using annotate because I can't figure out how to move segment text
  #Note when re-run should double check envfit stats to make sure that soil parameters are the same
  geom_text(data=vec,aes(x=Dim1,y=Dim2,label=vec$parm),size=5, inherit.aes=F)+
  #annotate("text",x=-0.02,y=0.2, label="C%") +
  #annotate("text",x=0.02,y=0.2, label="N%") +
  #annotate("text",x=0,y=-.2, label="moisture") +
  #annotate("text",x=0.1,y=-.225, label="pH") +
  #Set error bacrs for geom_point
  geom_errorbarh(aes(xmax=V1+V1e, xmin=V1-V1e, height=0.02), colour="black") +    
  geom_errorbar(aes(ymax=V2+V2e, ymin=V2-V2e, width=0.02), colour="black") + 
  #Set colors for treatments
  #scale_colour_manual(values = c("#999999", "#000000")) +
  scale_colour_manual(values = c("#EB8F43", "#9BBB59","purple","red","yellow","blue","gray","pink","magenta")) +
  #Would have liked to set shapes but couldn't get this to work
  #scale_shape_manual(values = c(22, 21, 24)) +
  #Sets map coordinates
  coord_cartesian(xlim = c(-0.3, 0.3), ylim = c(-0.3, 0.3)) +
  #Sets axis text and put border around plot
  theme(axis.title = element_text(size=14), 
        axis.text.x = element_text(size=14),  axis.text.y = element_text(size=14),
        panel.border = element_rect(colour = "black", size=1.25)) +
  #Set plot title textsize
  theme(plot.title=element_text(size=14)) +
  #Set legend text size
  theme(legend.text=element_text(size=14), legend.title = element_text(size=14))+
  #Sets size of tick marks on axis
  theme(axis.ticks.length=unit(0.3,"cm")) + 
  #Sets labels for plot title, axis titles, and legend headings
  xlab("PCoA 1 (29.1%)") + ylab("PCoA 2 (12.2%)") + 
  labs(shape = "Soil Source") +
  labs(colour="treatment") +
  ggtitle("16S rRNA Microbial Community Analysis") 
  
plot1 

#Save a copy of the plot
ggsave("../WRC18_Rhizo/figures/16SrRNA_WRC2018Rhizo.jpg", plot=last_plot(), device=NULL, path=NULL, scale=1, width=8.7, height=6.3, dpi=900, limitsize=TRUE)

```

```{r Presence_Absence and Species richness }
#Transform data to reflect only presence or absence ie 0 or 1
otu.2.PA<-(otu.rare>0*1)
#sanity check 
#otu.2.PA[,1:5]
#Add meta data
metaotu.2 <- cbind(meta, otu.2.PA)
#metaotu.2[1:15]
#Transform True/False to 0/1 
cols <- sapply(metaotu.2, is.logical)
metaotu.2[,cols]<-lapply(metaotu.2[,cols],as.numeric)
#head(metaotu.2)
```

```{r diversity metrics: richness}
#chao1 richness index
chao1 <- estimateR(otu.2)
c <- as.data.frame(chao1)
ct <- t(c)
otu.div <- cbind(meta, ct)

#interaction variable so can use Tukey
i <- with(otu.div, interaction(treatment, source))

richness.lm <- aov(S.chao1 ~ treatment + source + i, data = otu.div)
plot(richness.lm)
anova(richness.lm)
#Get Tukey post hoc groups p<=0.01*
t <- HSD.test(richness.lm, "i", group=TRUE, alpha=.05)
t
plot(t)

#Set variable names for plot
#levels(meta$treatment) <- c("Unfertilized", "Fertilized")
#p <- meta$source
#p <- ordered(p,levels=c("bulk","av", "ec"))
#p <- revalue(p, c("bulk"="Bulk Soil", "av"="Grass", "ec"="Forb"))
#p <- mapvalues(p, from = c("bulk","av","ec"), to = c("Bulk Soil", "Grass", "Forb"))

#Plot
chao<- ggplot(otu.div, aes(x=i, y=S.chao1, fill=treatment))  +
  geom_boxplot(binaxis='y', stackdir='center') + scale_fill_manual(values=c("#999999", "#000000")) +
#Set labels for Tukey groups
annotate("text",x=0.82,y=5200, label="b") +
annotate("text",x=1.81,y=5400, label="b") +
annotate("text",x=2.81,y=5725, label="b") +
annotate("text",x=1.1815,y=7050, label="a") +
annotate("text",x=2.19,y=6600, label="bc") + 
annotate("text",x=3.19,y=6250, label="ab") + 
#Set plot elements
theme_bw()  +
#Remove plot gridlines
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
#Set axis title and text properties, tick marks, and labels
theme(axis.title=element_text(size=14,face="bold"),
          axis.text=element_text(size=14),  
          axis.title.y=element_text(margin=margin(r=10)),
          panel.border = element_rect(colour = "black",size=1), legend.position="bottom") + 
          theme(axis.ticks.length=unit(0.3,"cm")) + 
          labs(x = "", y = "Chao1 species richness")
chao
#Save a copy of the plot
ggsave("../WRC18_Rhizo/figures/chao1.jpg", plot=chao, device=NULL, path=NULL, scale=1, width=6.3, height=4.4, dpi=900, limitsize=TRUE)


```

```{r diversity metrics - calculate diversity and evenness}
# Calculate diversity metrics
shannon <- diversity(otu.rare, "shannon")
simp <- diversity(otu.rare, "simpson")
invsimp <-diversity(otu.rare, "invsimpson")
# Pielous evenness (uses presence/absence data)
J <- shannon/log(specnumber(otu.2.PA[,-c(1:1)]))

#Adding diversity fields to dataset
otu.div$shannon <- NULL
otu.div$J <- NULL
otu.div$simp <- NULL
otu.div$invsimp <- NULL
otu.div <- cbind(otu.div,shannon,J, simp, invsimp)
```

```{r diversity metrics - display shannon }
#Run richness first. interaction, levels, and treatments for plotting set there
shannon.lm <- aov(shannon ~ treatment + source + i, data = otu.div)
plot(shannon.lm)
anova(shannon.lm)

#Tukey groups at p<=0.01*
t <- HSD.test(shannon.lm, "i", group=TRUE, alpha=0.05)
t
plot(t)

#p is set in richness chuck
shan<- ggplot(otu.div, aes(x=i, y=shannon, fill=treatment))  +
  geom_boxplot() + scale_fill_manual(values=c("#999999", "#000000"))  + annotate("text",x=0.82,y=6.1, label="bc") +
annotate("text",x=1.81,y=5.9, label="c") +
annotate("text",x=2.81,y=6.05, label="c") +
annotate("text",x=1.1815,y=6.5, label="a") +
annotate("text",x=2.19,y=6.3, label="ab") + 
annotate("text",x=3.19,y=6.35, label="ab") + 
#Set plot elements
theme_bw()  +
#Remove plot gridlines
theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
#Set axis title and text properties, tick marks, and labels
theme(axis.title=element_text(size=14,face="bold"),
          axis.text=element_text(size=14), axis.text.x = element_blank(), 
          axis.title.y=element_text(margin=margin(r=10)),
          panel.border = element_rect(colour = "black",size=1), legend.position="none") + 
          theme(axis.ticks.length=unit(0.3,"cm")) + 
          labs(x = "", y = "Shannon diversity H'")

shan

ggsave("../WRC18_Rhizo/figures/shannon.jpg", plot=shan, device=NULL, path=NULL, scale=1, width=6.3, height=4.4, dpi=900, limitsize=TRUE)
```

```{r diversity metrics - Pielous evennes J}
J.lm <- aov(J ~ treatment + source + i , data = otu.div)
plot(J.lm)
anova(J.lm)
#TukeyHSD(J.lm)
t <- HSD.test(J.lm, "i", group=TRUE, alpha=0.05)
t
plot(t)

even<- ggplot(otu.div, aes(x=i, y=J, fill=treatment))  +
  geom_boxplot() + scale_fill_manual(values=c("#999999", "#000000")) +
#Set Tukey groups
annotate("text",x=0.82,y=0.77, label="ab") +
annotate("text",x=1.81,y=0.75, label="b") +
annotate("text",x=2.81,y=0.76, label="b") +
annotate("text",x=1.1815,y=0.80, label="a") +
annotate("text",x=2.19,y=0.78, label="a")  + 
annotate("text",x=3.19,y=0.80, label="a")  + 
#Set plot properties
theme_bw()  +
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(), 
          axis.title.y=element_text(margin=margin(r=10)), 
          axis.title.x=element_text(margin=margin(t=10))) +
    theme(axis.title=element_text(vjust=1,size=14,face="bold"),
          axis.text=element_text(size=14), axis.text.x = element_text(size=14), panel.border = 
          element_rect(colour = "black",size=1)) + 
    theme(axis.ticks.length=unit(0.3,"cm")) + labs(x = "Soil Source", y = "Pileou's eveness") + 
    theme(legend.text=element_text(size=14), legend.title = element_text(size=14), 
          legend.position = "bottom")

even 

ggsave("../WRC18_Rhizo/figures/even.jpg", plot=even, device=NULL, path=NULL, scale=1, width=6.3, height=4.4, dpi=900, limitsize=TRUE)

```

```{r environmental parameters}
meta.env <- meta 

#SUMMARY TABLES
by_plant_treatment <- meta.env %>%
  group_by(source, treatment) %>%
  summarise_all(funs(mean,sd), na.rm=T)

write.csv(by_plant_treatment, file = "by_plant_treatment.csv",row.names=TRUE)

by_treatment <- meta.env %>%
  group_by(treatment) %>%
  summarise_all(funs(mean,sd), na.rm=T)

#i <- with(meta.env, interaction(Treatment, plant))

####STOPPED HERE --- need to update column names and add phosphorus

#NP ratio 
bio_NP <- aov(meta.env$bio_NP ~ treatment, meta.env)
plot(bio_NP)
anova(bio_NP)

bio_NP_p<- ggplot(meta.env[-c(3,17),], aes(x=source, y=bio_NP, fill=treatment))  +
  geom_boxplot() + scale_fill_manual(values=c("#999999", "#000000","333333","444444"))
bio_NP_p

ggsave("../WRC18_Rhizo/figures/bio_NP.jpg", plot=bio_NP_p, device=NULL, path=NULL, scale=1, width=6.3, height=4.4, dpi=900, limitsize=TRUE)

tot_NP <- aov(meta.env$tot_NP ~ treatment, meta.env)
plot(tot_NP)
anova(tot_NP)

tot_NP_p<- ggplot(meta.env, aes(x=source, y=tot_NP, fill=treatment))  +
  geom_boxplot() + scale_fill_manual(values=c("#999999", "#000000","333333","444444"))
tot_NP_p

ggsave("../WRC18_Rhizo/figures/tot_NP.jpg", plot=tot_NP_p, device=NULL, path=NULL, scale=1, width=6.3, height=4.4, dpi=900, limitsize=TRUE)

#KCl extractable Ammonium and Nitrate
nh4 <- aov(meta.env$n_nh4_ug_gsoil ~ treatment, meta.env)
plot(nh4)
anova(nh4)

nh4<- ggplot(meta.env, aes(x=source, y=n_nh4_ug_gsoil, fill=treatment))  +
  geom_boxplot() + scale_fill_manual(values=c("#999999", "#000000","333333", "444444"))+
  facet_grid(meta.env$year)
nh4


pH <- aov(pH ~ treatment , meta.env)
plot(pH)
anova(pH)

ppH<- ggplot(meta.env, aes(x=treatment, y=pH, fill=plant))  +
  geom_boxplot() + scale_fill_manual(values=c("#999999", "#000000", "333333"))
ppH

#t <- HSD.test(pH, "i" , group=TRUE, alpha=0.05)
#t
#plot(t)

no3 <- aov(no3_mg.l ~ treatment , data=meta.env) 
plot(no3)
anova(no3)

avg_temp_C <- aov(avg_temp_C ~ treatment , data=meta.env) 
plot(avg_temp_C)
anova(avg_temp_C)

moist_percent <- aov(moist_percent ~ treatment , data=meta.env) 
plot(moist_percent)
anova(moist_percent)

TN <- aov(TN ~ treatment , data=meta.env) 
plot(TN)
anova(TN)

c_percent <- aov(c_percent ~ treatment , data=meta.env) 
plot(c_percent)
anova(c_percent)

n_percent <- aov(n_percent ~ treatment , data=meta.env) 
plot(n_percent)
anova(n_percent)

C_N <- aov(C_N ~ treatment , data=meta.env) 
plot(C_N)
anova(C_N)

```


```{r gene copy analysis}
#Need to process sequence fasta via rrna db first
```

```{r BIOLOG Import data}
#Read in biolog files 
#There is one file for each treatment and all timepoints (n=12) that includes 5 different plates: One ECO (n=31), two PM3 (95), two PM4 (94). 220 different substrates 

#Per treatment all timepoints and plates combined into one file
#Coalesce all files into one master file
getwd()

bulk <- read.csv("../data/WRC18_Rhizo/biolog_bulk.csv")
grass <- read.csv("../data/WRC18_Rhizo/biolog_grass.csv")
forb <- read.csv("../data/WRC18_Rhizo/biolog_forb.csv")

#bulk + forb + grass
biolog_master <- rbind(bulk, grass, forb)

```

```{r BIOLOG ECO/CARBON Utilization}
#Subset master biolog file to include only ECO plates
eco <- biolog_master[(biolog_master$plate_type %in% "ECO"),]

#For each timepoint and each sample calculate the AWCD 
#AWCD is average well color development. 
#AWCD = ???ODi/31
#OD is the optical density value from each well corrected substracting the blank well value from each plate well

eco_reps <- eco %>% 
  group_by(timepoint, sample, plate_num, Substance) %>% #combine reps 
  summarise(avg_abs = mean(abs))  #average abs for each substance
  
water_by_plate <- eco %>%
  filter(Substance == "water") %>%
  group_by(sample, plate_num, Substance) %>%
  summarise(avg_abs=mean(abs))

#I need to subtract the water_by_plate$avg_abs from each in eco_reps where 
#water_byplate$sample == eco_reps$sample and water_by_plate$plate_num=eco_reps$plate_num
eco_reps_water <- eco_reps %>% left_join(water_by_plate, by=c("sample","plate_num"))

#Then from each ABS average substract average control ABS
#Sum and divide by 31 (the number of substrates)
eco_reps_AWCD <- eco_reps_water %>%
  mutate(corr_abs = avg_abs.x-avg_abs.y) %>%
  mutate(AWCD = sum(corr_abs)/31) 

colnames(eco_reps_AWCD)
eco_reps_AWCD_sub <- eco_reps_AWCD %>%
  dplyr::select(timepoint, sample, AWCD)
  


#have seen plotted as treatment over time, AWCD calculated for each timepoint line graph
#also seen plotted as all treatments and one time point bar graph

#Then need to calculate richness, Shannon H', and eveness
#For each time point each treatment or all treatments and one timepoint? 

#Do any substrate groups stand out? 




```
